# taken from https://github.com/ether/etherpad-lite/wiki/How-to-put-Etherpad-Lite-behind-a-reverse-Proxy

upstream etherpad-lite {
  server 127.0.0.1:9001;
}

server {
  listen       80;
  server_name  etherpad.osuosl.org test-notes.openmrs.org notes.openmrs.org *.etherpad-lite.osuosl.org etherpad-lite.osuosl.org;


  # Allow normal files to pass through
  location ~ ^/(locales/|locales.json|admin/|static/|pluginfw/|javascripts/|socket.io/|ep/|minified/|api/|ro/|error/|jserror/|favicon.ico|robots.txt) {
    proxy_buffering off;
    proxy_pass http://etherpad-lite;
  }

  # Redirect to force /p/* URLs to the friendly version
  location /p/ {
    rewrite ^/p/(.*) /$1 redirect;
  }

  # Match the home page
  location ~ ^/$ {
    proxy_buffering off;
    proxy_pass http://etherpad-lite;
  }


  # Handle pad URLs here
  location / {
    proxy_buffering off;
    proxy_pass http://etherpad-lite/p/;
    proxy_redirect / /p/;
  }
}
server {
  listen  443;
  server_name  localhost test-notes.openmrs.org notes.openmrs.org;

  ssl on;
  ssl_certificate /etc/pki/tls/certs/notes-openmrs.pem;
  ssl_certificate_key /etc/pki/tls/private/notes-openmrs.key;

  ssl_session_timeout  5m;


  ssl_protocols  <%= node['osl-nginx']['ssl_protocols'] %>;
  ssl_ciphers '<%= node['osl-nginx']['ssl_ciphers'].join(':') %>';
  ssl_prefer_server_ciphers   on;

  access_log  /var/log/nginx/localhost.access.log;

  # Allow normal files to pass through
  location ~ ^/(locales/|locales.json|admin/|static/|pluginfw/|javascripts/|socket.io/|ep/|minified/|api/|ro/|error/|jserror/|favicon.ico|robots.txt) {
    proxy_buffering off;
    proxy_pass http://etherpad-lite;
  }

  # Redirect to force /p/* URLs to the friendly version
  location /p/ {
    rewrite ^/p/(.*) /$1 redirect;
  }

  # Match the home page
  location ~ ^/$ {
    proxy_buffering off;
    proxy_pass http://etherpad-lite;
  }

  # Handle pad URLs here
  location / {
    proxy_buffering off;
    proxy_pass http://etherpad-lite/p/;
    proxy_redirect / /p/;
  }
}
